# linea di comando:
# ansible-playbook -i external-inventory -i fsimonetti.vmware.yml --vault-password-file ~/.password --extra-vars @testvm11.yml deploy.yml
---
- hosts: localhost
  gather_facts: true
  vars_files:
    - ./acilia.yml
  tasks:
  # LINUX Vcd ce
  - name: complete deployment of a Linux VM
    when: vmtype == "linux" 
    block:
      - name: Clone a virtual machine from CentOS template and customize
        register: vm
        vmware_guest:
          hostname: "{{ vcenter_hostname }}"
          username: "{{ vcenter_username }}"
          password: "{{ vcenter_password }}"
          validate_certs: no
          datacenter: "{{ vsphere_datacenter }}"
          cluster: "{{ vsphere_cluster }}"
          datastore: "{{ vmdatastore }}"
          name: "{{ vmhostname }}"
          annotation: "{{ vmdescription }}"
          folder: "/{{ vsphere_datacenter }}/vm{{ vmfolder }}"
          template: "{{ template }}"
          hardware:
            memory_mb: "{{ vmram }}"
            num_cpus: "{{ vmcpu }}"
            osid: "{{ vmosid }}"
            scsi: paravirtual
          networks:
          - name: "{{ vmnetname }}"
            ip: "{{ vmaddress }}"
            netmask: "{{ vmnetmask }}"
            gateway: "{{ vmgateway }}"
          customization:
            dns_servers:
            - "{{ addns1 }}"
            - "{{ addns2 }}"
            dns_suffix:
            - "{{ addomain }}"
            domain: "{{ addomain }}"
            timezone: "{{ adtimezone }}"
            hwclockUTC: true
          state: poweredon
          wait_for_ip_address: true
          wait_for_customization: true
      - name: Add newly created Linux VM to inventory
        add_host:
          name: "{{ vm.instance.ipv4 }}"
          group: linuxvms
          hw_guest_id: "{{ vm.instance.hw_guest_id }}"
          hw_guest_full_name: "{{ vm.instance.hw_guest_full_name }}"
          hw_name: "{{ vm.instance.hw_name }}"
      - name: record VM creation date/time
        shell: date +%Y%m%d%H%M
        register: deploydate
      - name: add attribute DEPLOYDATE to new VM
        vmware_guest_custom_attributes:
          hostname: "{{ vcenter_hostname }}"
          username: "{{ vcenter_username }}"
          password: "{{ vcenter_password }}"
          validate_certs: no
          name: "{{ vm.instance.hw_name }}"
          state: present
          attributes:
            - name: DEPLOYDATE
              value: "{{ deploydate.stdout }}"
      - name: add attribute DEPLOYTEMPLATE to new VM
        vmware_guest_custom_attributes:
          hostname: "{{ vcenter_hostname }}"
          username: "{{ vcenter_username }}"
          password: "{{ vcenter_password }}"
          validate_certs: no
          name: "{{ vm.instance.hw_name }}"
          state: present
          attributes:
            - name: DEPLOYTEMPLATE
              value: "{{ template }}"

# LINUX VM      
- hosts: linuxvms
  gather_facts: true
  become: yes
  user: admbvtech
  vars_files:
    - ./acilia.yml
  tasks:
    - name: install security updates (CentOS8)
      register: security
      when: hw_guest_id == "centos8_64Guest"
      dnf:
        state: latest
        update_cache: yes
        security: yes
        name: '*'
    - name: install bugfix/errata (CentOS8)
      register: bugfix
      when: hw_guest_id == "centos8_64Guest"
      dnf:
        state: latest
        update_cache: yes
        bugfix: yes
        name: '*'
    - name: install security updates (CentOS7)
      register: security
      when: hw_guest_id == "centos7_64Guest"
      yum:
        state: latest
        update_cache: yes
        security: yes
        name: '*'
    - name: install bugfix/errata (CentOS7)
      register: bugfix
      when: hw_guest_id == "centos7_64Guest"
      yum:
        state: latest
        update_cache: yes
        bugfix: yes
        name: '*'
    - debug: var=security
    - debug: var=bugfix