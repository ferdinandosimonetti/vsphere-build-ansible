---
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../deployvariables.yml
  tasks:
  - name: Gathering ipam auth token
    uri:
      validate_certs: false
      url: "{{ ipam_token_request }}"
      method: POST
      user: "{{ ipam_api_user }}"
      password: "{{ ipam_api_pass | trim }}"
      force_basic_auth: yes
    register: output
    failed_when: output.json.success != true

  - name: getting subnet id
    uri:
      validate_certs: false
      url: "{{ ipam_lookup_network }}{{ vmnetwork }}"
      headers: token="{{ output.json.data.token }}"
    register: subnetid
    failed_when: subnetid.json.success != true

  - name: checking subnet for next available ip address
    uri:
      validate_certs: false
      url: "{{ ipam_lookup_ip }}{{ subnetid.json.data[0].id | int }}"
      headers: token="{{ output.json.data.token }}"
    register: ipaddress
    failed_when: ipaddress.json.success != true

  - name: reserve ip address
    uri:
      validate_certs: false
      url: "{{ ipam_lookup_ip }}{{ subnetid.json.data[0].id | int }}"
      method: POST
      headers: 
        token: "{{ output.json.data.token }}"
        Content-Type: application/json
      body_format: json
      status_code: 201
      body:
        hostname: "{{ vmhostname }}"
        description: "{{ vmdescription }}"
    register: resipaddr
    failed_when: resipaddr.json.success != true

  - debug: msg="{{ vmhostname }} assigned IP is {{ resipaddr.json.data }}"

  - name: Create a category
    vmware_category:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      category_name: tempcategory.{{ vmhostname }}
      category_description: "Temporary Category {{ vmhostname }}"
      category_cardinality: 'multiple'
      state: present
      validate_certs: no
    delegate_to: localhost
    register: results
  
  - name: create temporary tag
    delegate_to: localhost
    vmware_tag:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: no
      tag_name: "temporarytag.{{ vmhostname }}"
      tag_description: "tag for {{ vmhostname }}"
      category_id: "{{ results.category_results.category_id }}"
      state: present

  - meta: refresh_inventory

  - name: Clone a virtual machine from CentOS template and customize
    delegate_to: localhost
    vmware_guest:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      validate_certs: no
      datacenter: "{{ myvmdcname }}"
      cluster: "{{ myvmclname }}"
      # to be passed with --extra-vars
      name: "{{ vmhostname }}"
      folder: "/{{ myvmdcname }}/vm"
      template: "centos8template"
      networks:
      - name: VM Network
        ip: "{{ resipaddr.json.data }}"
        netmask: 255.255.255.0
        gateway: 192.168.101.2
      customization:
        dns_servers:
        - 192.168.101.104
        dns_suffix:
        - "{{ myaddomain }}"
        domain: "{{ myaddomain }}"
#        # For Windows VMs        
#        # https://docs.microsoft.com/en-us/previous-versions/windows/embedded/ms912391(v=winembedded.11)?redirectedfrom=MSDN
#        timezone: 110
        timezone: "{{ mytimezone }}"
        hwclockUTC: true
      state: poweredon
      wait_for_ip_address: true
      wait_for_customization: true

- hosts: localhost
  gather_facts: true
  vars_files:
    - ../deployvariables.yml
  tasks:  
  - name: Add new tag to the new vm
    vmware_tag_manager:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: no
      tag_names: 
      - "temporarytag.{{ vmhostname }}"
      object_name: "{{ vmhostname }}"
      object_type: VirtualMachine
      state: add
    delegate_to: localhost

  - name: record VM creation date/time
    shell: date +%Y%m%d%H%M
    register: creationdate
  
  - name: add attribute CREATIONDATE to new VM
    vmware_guest_custom_attributes:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      validate_certs: no
      name: "{{ vmhostname }}"
      state: present
      attributes:
        - name: CREATIONDATE
          value: "{{ creationdate.stdout }}"
    delegate_to: localhost

  - meta: refresh_inventory

  - pause:
      minutes: 1

- hosts: "temporarytag.{{ vmhostname }}"
  gather_facts: true
  become: yes
  vars_files:
    - ../deployvariables.yml
  user: admbvtech
  tasks:

    - name: Install pexpect using pip
      pip:
        name: pexpect

- hosts: localhost
  gather_facts: true
  vars_files:
    - ../deployvariables.yml
  tasks:
    - name: delete temporary tag
      delegate_to: localhost
      vmware_tag:
        hostname: '{{ vcenter_hostname }}'
        username: '{{ vcenter_username }}'
        password: '{{ vcenter_password }}'
        validate_certs: no
        tag_name: "temporarytag.{{ vmhostname }}"
        tag_description: "tag for {{ vmhostname }}"
        category_id: "{{ results.category_results.category_id }}"
        state: absent
      register: results

    - name: delete a category
      vmware_category:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        category_name: tempcategory.{{ vmhostname }}
        category_description: "Temporary Category {{ vmhostname }}"
        category_cardinality: 'multiple'
        state: absent
        validate_certs: no
      delegate_to: localhost
      register: results
